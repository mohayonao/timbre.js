(function(e){"use strict";function t(t){e.Object.call(this,2,t),n.fixAR(this);var s=this._;s.mode="",s.bufferL=new n.SignalArray(r<<2),s.bufferR=new n.SignalArray(r<<2),s.buffermask=s.bufferL.length-1,s.node=null,s.script=i.createJavaScriptNode(r,2,2),s.writeIndex=0,s.readIndex=0,s.totalRead=0,s.totalWrite=0}if("webkit"===e.env){var n=e.fn,i=n._audioContext,r=1024;n.extend(t);var s=t.prototype;Object.defineProperties(s,{context:{get:function(){return i}},mode:{get:function(){return this._.mode}}}),s.cancel=function(){for(var e=this._,t=this.cells[0],n=0,i=t.length;i>n;++n)t[n]=0;e.node=null},function(){function e(e){t.call(this,e);var n=this._;n.mode="recv",n.script.onaudioprocess=r(this),n.gain=i.createGainNode(),n.gain.gain.value=0,n.script.connect(n.gain)}n.extend(e,t);var r=function(e){return function(t){var n=e._,i=t.inputBuffer,r=i.getChannelData(0),s=i.getChannelData(1),o=i.length,a=n.writeIndex;n.bufferL.set(r,a),n.bufferR.set(s,a),n.writeIndex=a+o&n.buffermask,n.totalWrite+=o}},s=e.prototype;s.cancel=function(){t.prototype.cancel.call(this),this._.gain.disconnect(),this._.node&&this._.node.disconnect()},s.recv=function(e){var t=this._;try{t.node=e,t.node.connect(t.script),t.gain.connect(i.destination)}catch(n){t.node=null}return t.writeIndex=0,t.readIndex=0,t.totalWrite=0,t.totalRead=0,this},s.process=function(e){var t=this._;if(null===t.node)return this;if(this.tickID!==e){this.tickID=e;var i=t.cellsize,r=t.bufferL,s=t.bufferR;if(t.totalWrite>t.totalRead+i){var o=t.readIndex,a=o+i;this.cells[1].set(r.subarray(o,a)),this.cells[2].set(s.subarray(o,a)),t.readIndex=a&t.buffermask,t.totalRead+=i}n.outputSignalAR(this)}return this},n.register("WebAudioAPI:recv",e)}(),function(){function e(e){t.call(this,e),n.listener(this);var r=this._;r.mode="send",r.script.onaudioprocess=i(this),r.connectIndex=null}n.extend(e,t);var i=function(e){return function(t){var n=e._,i=t.outputBuffer,r=i.length;if(n.totalWrite>n.totalRead+r){var s=n.readIndex,o=s+r;i.getChannelData(0).set(n.bufferL.subarray(s,o)),i.getChannelData(1).set(n.bufferR.subarray(s,o)),n.readIndex=o&n.buffermask,n.totalRead+=r}}},r=e.prototype;r.cancel=function(){t.prototype.cancel.call(this);var e=this._;null!==e.connectIndex?e.script.disconnect(e.connectIndex):e.script.disconnect(),this.unlisten()},r.send=function(e,t){var n=this._;try{n.node=e,"number"==typeof t?(n.script.connect(n.node,t),n.connectIndex=t):(n.script.connect(n.node),n.connectIndex=null),this.listen()}catch(i){n.node=null}return n.writeIndex=0,n.readIndex=0,n.totalWrite=0,n.totalRead=0,this},r.process=function(e){var t=this._;if(null===t.script)return this;if(this.tickID!==e){this.tickID=e;var i=this.cells[1],r=this.cells[2],s=t.cellsize,o=t.writeIndex;n.inputSignalAR(this),t.bufferL.set(i,o),t.bufferR.set(r,o),t.writeIndex=o+s&t.buffermask,t.totalWrite+=s,n.outputSignalAR(this)}return this},n.register("WebAudioAPI:send",e)}()}})(timbre);